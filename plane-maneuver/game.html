<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Plane Maneuver - Endless Play</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
        }
        canvas {
            display: block;
            background-color: #87CEEB; /* Sky Blue */
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .ui-button {
             @apply px-8 py-4 bg-gradient-to-br from-sky-400 to-sky-600 text-white font-semibold rounded-xl shadow-lg border-b-4 border-sky-800 hover:from-sky-500 hover:to-sky-700 active:border-b-0 active:translate-y-1 transition-all duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-sky-300;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <div id="score-container" class="fixed top-5 left-5 text-3xl font-orbitron text-white pointer-events-none" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7); z-index: 10;">
        SCORE: <span id="score">0</span>
    </div>

    <script>
        // --- SETUP ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const scoreContainer = document.getElementById('score-container');

        // --- GAME STATE & CONFIG ---
        let gameState = 'loading'; // loading, playing, crashed
        let animationFrameId;
        let score = 0;
        let frameCount = 0;
        let currentSpeed = 3;
        const baseSpeed = 3;
        const obstacleSpawnRate = 120;
        const gapHeight = 250;
        let playerState = {};

        // --- PLAYER ---
        const player = {
            x: 150, y: 200, width: 64, height: 64,
            targetX: 150, targetY: 200, speed: 0.1, svg: new Image()
        };

        // --- OBSTACLES ---
        let obstacles = [];

        // --- PLANE DATABASE ---
        const planeData = [
            { id: 'sparrow', svg: '<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g style="image-rendering: pixelated;"><rect x="2" y="12" width="28" height="8" fill="#EF4444"/><rect x="13" y="6" width="6" height="20" fill="#FFFFFF"/><rect x="11" y="24" width="10" height="4" fill="#EF4444"/><rect x="14" y="10" width="4" height="4" fill="#3B82F6"/><rect x="15" y="2" width="2" height="6" fill="#4B5563"/><rect x="12" y="4" width="8" height="2" fill="#4B5563"/></g></svg>' },
            { id: 'vacayer', svg: '<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g style="image-rendering: pixelated;"><rect x="0" y="14" width="32" height="6" fill="#3B82F6"/><rect x="14" y="8" width="4" height="18" fill="#FFFFFF"/><rect x="12" y="24" width="8" height="4" fill="#3B82F6"/><rect x="15" y="12" width="2" height="4" fill="#FFFFFF"/><rect x="6" y="12" width="4" height="8" fill="#4B5563"/><rect x="22" y="12" width="4" height="8" fill="#4B5563"/><rect x="7" y="10" width="2" height="4" fill="#9CA3AF"/><rect x="23" y="10" width="2" height="4" fill="#9CA3AF"/></g></svg>' },
            { id: 'hawk', svg: '<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g style="image-rendering: pixelated;"><path d="M16 4 L12 16 L12 26 L20 26 L20 16 Z" fill="#DC2626"/><path d="M12 16 L2 22 L2 24 L12 20 Z" fill="#DC2626"/><path d="M20 16 L30 22 L30 24 L20 20 Z" fill="#DC2626"/><path d="M14 26 L12 30 L20 30 L18 26 Z" fill="#DC2626"/><rect x="14" y="10" width="4" height="6" fill="#3B82F6"/></g></svg>' },
            { id: 'tomcat', svg: '<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g style="image-rendering: pixelated;"><path d="M16 2 L13 12 L13 28 L19 28 L19 12 Z" fill="#D1D5DB"/><path d="M13 12 L4 20 L8 22 L13 16 Z" fill="#D1D5DB"/><path d="M19 12 L28 20 L24 22 L19 16 Z" fill="#D1D5DB"/><path d="M12 26 L10 30 L13 30 L13 26 Z" fill="#6B7280"/><path d="M20 26 L22 30 L19 30 L19 26 Z" fill="#6B7280"/><rect x="14" y="8" width="4" height="6" fill="#111827"/></g></svg>' },
            { id: 'eagle', svg: '<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g style="image-rendering: pixelated;"><path d="M16 8 L6 22 L26 22 Z" fill="#4B5563"/><path d="M16 2 L14 8 L14 28 L18 28 L18 8 Z" fill="#4B5563"/><path d="M15 26 L12 30 L20 30 L17 26 Z" fill="#1F2937"/><rect x="15" y="10" width="2" height="6" fill="#FBBF24"/></g></svg>' },
            { id: 'raptor', svg: '<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g style="image-rendering: pixelated;"><path d="M16 2 L14 8 L14 28 L18 28 L18 8 Z" fill="#9CA3AF"/><path d="M14 24 L2 22 L14 16 Z" fill="#9CA3AF"/><path d="M18 24 L30 22 L18 16 Z" fill="#9CA3AF"/><path d="M14 28 L12 31 L14 31 Z" fill="#4B5563"/><path d="M18 28 L20 31 L18 31 Z" fill="#4B5563"/><rect x="15" y="8" width="2" height="6" fill="#111827"/></g></svg>' },
            { id: 'lightning', svg: '<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g style="image-rendering: pixelated;"><path d="M16 2 L14 8 L13 14 L13 28 L19 28 L19 14 L18 8 Z" fill="#6B7280"/><path d="M13 15 L2 18 L8 24 L13 20 Z" fill="#6B7280"/><path d="M19 15 L30 18 L24 24 L19 20 Z" fill="#6B7280"/><path d="M13 28 L10 31 L13 31 Z" fill="#4B5563"/><path d="M19 28 L22 31 L19 31 Z" fill="#4B5563"/><rect x="14" y="7" width="4" height="6" fill="#111827"/></g></svg>' },
            { id: 'nextgen', svg: '<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g style="image-rendering: pixelated;"><path d="M16 2 L4 28 L12 26 L16 30 L20 26 L28 28 Z" fill="#9CA3AF"/><rect x="14" y="8" width="4" height="6" fill="#111827"/></g></svg>' },
        ];

        // --- FUNCTIONS ---
        function loadState() {
            const savedState = localStorage.getItem('planeManeuverSave');
            if (savedState) {
                playerState = JSON.parse(savedState);
            } else {
                playerState = { coins: 0, ownedPlanes: ['sparrow'], selectedPlane: 'sparrow' };
            }
        }

        function createObstacle() {
            const minHeight = 100;
            const maxHeight = canvas.height - gapHeight - minHeight;
            const gapY = Math.random() * (maxHeight - minHeight) + minHeight;
            obstacles.push({ x: canvas.width, y: 0, width: 80, height: gapY, passed: false });
            obstacles.push({ x: canvas.width, y: gapY + gapHeight, width: 80, height: canvas.height - (gapY + gapHeight) });
        }

        function drawCloud(x, y, width, height) {
            ctx.fillStyle = '#d1d5db';
            ctx.fillRect(x, y, width, height);
        }

        function gameLoop() {
            if (gameState !== 'playing') return;

            frameCount++;
            player.x += (player.targetX - player.x) * player.speed;
            player.y += (player.targetY - player.y) * player.speed;

            if (frameCount % obstacleSpawnRate === 0) createObstacle();

            const playerBox = {
                x: player.x + (player.width - player.height) / 2,
                y: player.y + (player.height - player.width) / 2,
                width: player.height,
                height: player.width
            };

            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obs = obstacles[i];
                obs.x -= currentSpeed;

                if (!obs.passed && playerBox.x > obs.x + obs.width) {
                    score++;
                    obs.passed = true;
                    if (score > 0 && score % 20 === 0) currentSpeed += 0.5;
                    if (score >= 10 && score % 10 === 0) {
                        playerState.coins += 10;
                    }
                }

                if (playerBox.x < obs.x + obs.width && playerBox.x + playerBox.width > obs.x && playerBox.y < obs.y + obs.height && playerBox.y + playerBox.height > obs.y) {
                    endGame();
                    return;
                }

                if (obs.x + obs.width < 0) obstacles.splice(i, 1);
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            obstacles.forEach(obs => drawCloud(obs.x, obs.y, obs.width, obs.height));

            ctx.save();
            ctx.translate(player.x + player.width / 2, player.y + player.height / 2);
            ctx.rotate(Math.PI / 2);
            ctx.drawImage(player.svg, -player.width / 2, -player.height / 2, player.width, player.height);
            ctx.restore();

            scoreEl.textContent = score;
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function startGame() {
            document.body.classList.remove('shake');

            const oldScreen = document.getElementById('game-over-screen');
            if (oldScreen) oldScreen.remove();

            canvas.style.display = 'block';
            scoreContainer.style.display = 'block';

            gameState = 'playing';
            obstacles = [];
            frameCount = 0;
            score = 0;
            currentSpeed = baseSpeed;
            player.y = canvas.height / 2 - player.height / 2;
            player.x = 150;
            player.targetX = player.x;
            player.targetY = player.y;

            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            gameLoop();
        }

        function endGame() {
            if (gameState === 'crashed') return;
            gameState = 'crashed';
            cancelAnimationFrame(animationFrameId);
            localStorage.setItem('planeManeuverSave', JSON.stringify(playerState));

            document.body.classList.add('shake');

            const gameOverScreen = document.createElement('div');
            gameOverScreen.id = 'game-over-screen';
            gameOverScreen.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                background-color: rgba(0,0,0,0.75); z-index: 9999;
            `;

            gameOverScreen.innerHTML = `
                <h1 class="font-orbitron text-8xl text-red-500 mb-4" style="text-shadow: 3px 3px 6px rgba(0,0,0,0.5);">You Crashed</h1>
                <p class="text-3xl text-white mb-8">Final Score: <span>${score}</span></p>
                <div class="flex gap-4">
                    <button id="restart-btn-dynamic">Try Again</button>
                    <button id="menu-btn-dynamic">Main Menu</button>
                </div>
            `;
            document.body.appendChild(gameOverScreen);

            const restartBtn = document.getElementById('restart-btn-dynamic');
            const menuBtn = document.getElementById('menu-btn-dynamic');

            const buttonClasses = "px-8 py-4 bg-gradient-to-br from-sky-400 to-sky-600 text-white font-semibold rounded-xl shadow-lg border-b-4 border-sky-800 hover:from-sky-500 hover:to-sky-700 active:border-b-0 active:translate-y-1 transition-all duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-sky-300";
            restartBtn.className = buttonClasses;
            menuBtn.className = buttonClasses;

            restartBtn.addEventListener('click', startGame);
            menuBtn.addEventListener('click', () => {
                window.location.href = 'index.html';
            });
        }

        function initializeGame() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            loadState();

            const selectedPlaneData = planeData.find(p => p.id === playerState.selectedPlane) || planeData[0];
            player.svg.src = "data:image/svg+xml," + encodeURIComponent(selectedPlaneData.svg);

            // **THE CRITICAL FIX IS HERE:**
            // We wait for the image to be fully loaded into memory before starting the game.
            player.svg.onload = () => {
                startGame();
            };
            // If the image fails to load, we still start the game so it doesn't get stuck.
            player.svg.onerror = () => {
                console.error("Player SVG failed to load. Starting game anyway.");
                startGame();
            };
        }

        // --- EVENT LISTENERS ---
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // No need to restart here, the game will adapt.
        });

        function handleMouseMove(e) {
            if (gameState !== 'playing') return;
            player.targetX = e.clientX - player.width / 2;
            player.targetY = e.clientY - player.height / 2;
        }
        window.addEventListener('mousemove', handleMouseMove);

        function handleTouchMove(e) {
            if (gameState !== 'playing') return;
            e.preventDefault();
            const touch = e.touches[0];
            player.targetX = touch.clientX - player.width / 2;
            player.targetY = touch.clientY - player.height / 2;
        }
        window.addEventListener('touchmove', handleTouchMove, { passive: false });

        // --- INITIALIZE ---
        initializeGame();

    </script>
</body>
</html>
